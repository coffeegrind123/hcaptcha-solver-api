<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solve Captcha - {{ task.request_type }}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff; min-height: 100vh;
            display: flex; flex-direction: column; align-items: center; padding: 20px;
        }
        header { text-align: center; margin-bottom: 20px; }
        h1 {
            font-size: 1.8em; font-weight: 600; margin-bottom: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .subtitle { color: #8b9dc3; font-size: 0.9em; }
        .container { max-width: 800px; width: 100%; }

        #timer {
            background: rgba(255,255,255,0.05); backdrop-filter: blur(10px);
            border: 2px solid rgba(102,126,234,0.3); border-radius: 12px;
            padding: 12px; text-align: center; margin-bottom: 16px;
        }
        #timer-display { font-size: 2.4em; font-weight: 700; color: #667eea; }
        .timer-label { color: #8b9dc3; font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px; }
        #timer-message { margin-top: 4px; font-size: 0.85em; }
        #timer.warning { border-color: rgba(255,193,7,0.6); animation: warningPulse 1s infinite; }
        #timer.warning #timer-display { color: #ffc107; }
        #timer.expired { border-color: rgba(244,67,54,0.6); animation: expiredPulse 0.5s infinite; }
        #timer.expired #timer-display { color: #f44336; }
        @keyframes warningPulse { 0%,100%{border-color:rgba(255,193,7,0.6)} 50%{border-color:rgba(255,193,7,1)} }
        @keyframes expiredPulse { 0%,100%{border-color:rgba(244,67,54,0.6)} 50%{border-color:rgba(244,67,54,1)} }
        .timer-message.warning { color: #ffc107; }
        .timer-message.expired { color: #f44336; font-weight: 600; }

        .question-bar {
            background: rgba(102,126,234,0.1); border-left: 3px solid #667eea;
            border-radius: 8px; padding: 12px 16px; margin-bottom: 16px;
            font-size: 1.05em;
        }

        .examples-row {
            display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;
        }
        .examples-row span { color: #8b9dc3; font-size: 0.85em; }
        .example-img {
            width: 60px; height: 60px; object-fit: cover; border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.15);
        }

        .solve-area {
            background: rgba(0,0,0,0.3); border: 2px solid rgba(102,126,234,0.3);
            border-radius: 12px; padding: 16px; position: relative;
            display: flex; justify-content: center;
        }
        #challenge-container { position: relative; display: inline-block; max-width: 100%; }
        #challenge-img {
            max-width: 100%; height: auto; display: block; border-radius: 8px;
            user-select: none; -webkit-user-drag: none;
        }

        .grid-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr);
        }
        .grid-cell {
            border: 1px solid rgba(76, 175, 80, 0.35); cursor: pointer;
            transition: background 0.15s; display: flex; align-items: center; justify-content: center;
        }
        .grid-cell:hover { background: rgba(76, 175, 80, 0.15); }
        .grid-cell.selected { background: rgba(76, 175, 80, 0.35); border-color: rgba(76, 175, 80, 0.7); }
        .grid-cell.selected::after {
            content: attr(data-index); font-size: 1.6em; font-weight: 700; color: #fff;
            text-shadow: 0 0 6px rgba(0,0,0,0.8);
        }

        .canvas-marker {
            position: absolute; width: 20px; height: 20px; border-radius: 50%;
            background: rgba(244,67,54,0.8); border: 2px solid #fff;
            transform: translate(-50%, -50%); pointer-events: none;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.7em; font-weight: 700; color: #fff;
        }

        .drag-point {
            position: absolute; width: 16px; height: 16px; border-radius: 50%;
            border: 2px solid #fff; transform: translate(-50%, -50%); pointer-events: none;
        }
        .drag-point.start { background: rgba(76,175,80,0.9); }
        .drag-point.end { background: rgba(244,67,54,0.9); }
        .drag-line {
            position: absolute; pointer-events: none; height: 3px;
            background: rgba(255,255,255,0.6); transform-origin: 0 50%;
        }

        .controls {
            margin-top: 16px; display: flex; gap: 12px; justify-content: center; align-items: center;
        }
        .btn {
            padding: 12px 32px; border: none; border-radius: 8px;
            font-weight: 600; font-size: 1em; cursor: pointer; transition: all 0.2s;
        }
        .btn-submit { background: #4CAF50; color: #fff; }
        .btn-submit:hover { background: #45a049; transform: translateY(-2px); }
        .btn-submit:disabled { background: #444; cursor: not-allowed; opacity: 0.5; }
        .btn-clear { background: rgba(255,255,255,0.1); color: #ccc; }
        .btn-clear:hover { background: rgba(255,255,255,0.2); }
        #answer-preview { color: #8b9dc3; font-size: 0.85em; min-height: 20px; }

        .result-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: none; align-items: center;
            justify-content: center; z-index: 100;
        }
        .result-box {
            background: #1a1a2e; border: 2px solid #4CAF50; border-radius: 16px;
            padding: 40px; text-align: center;
        }
        .result-box h2 { color: #4CAF50; margin-bottom: 12px; font-size: 1.5em; }
        .result-box p { color: #8b9dc3; }
    </style>
</head>
<body>
    <header>
        <h1>Solve: {{ task.request_type }} Challenge</h1>
        <p class="subtitle">Task {{ task.task_id[:8] }}</p>
    </header>
    <div class="container">
        <div id="timer">
            <div class="timer-label">Time Remaining</div>
            <div id="timer-display">--:--</div>
            <div id="timer-message" class="timer-message"></div>
        </div>

        <div class="question-bar">{{ task.question }}</div>

        {% if task.examples %}
        <div class="examples-row">
            <span>Examples:</span>
            {% for ex in task.examples %}
            <img class="example-img" src="data:image/png;base64,{{ ex }}" alt="example">
            {% endfor %}
        </div>
        {% endif %}

        <div class="solve-area">
            <div id="challenge-container">
                <img id="challenge-img" src="data:image/png;base64,{{ task.body }}" alt="challenge">
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-clear" id="btn-clear" onclick="solver.clear()">Clear</button>
            <div id="answer-preview"></div>
            <button class="btn btn-submit" id="btn-submit" onclick="solver.submit()" disabled>Submit</button>
        </div>
    </div>

    <div class="result-overlay" id="result-overlay">
        <div class="result-box">
            <h2>Submitted!</h2>
            <p>Answer sent. You can close this tab.</p>
        </div>
    </div>

    <script>
        const TASK_ID = "{{ task.task_id }}";
        const REQUEST_TYPE = "{{ task.request_type }}";
        const CREATED_AT = {{ task.created_at }};
    </script>
    <script src="/static/solver.js"></script>
    <script>
        (function() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const ws = new WebSocket(`${protocol}//${location.host}/ws/solver`);
            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                if (data.type === 'new_task' && data.task_id !== TASK_ID && solver.submitted) {
                    window.location.href = data.solve_url;
                }
            };
        })();
    </script>
</body>
</html>
